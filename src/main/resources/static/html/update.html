<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Edit Member</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                background: #f4f4f4;
                padding: 30px;
                margin: 0;
            }

            .custom-container {
                max-width: 500px;
                margin: auto;
                background-color: #fff;
                padding: 30px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            h4 {
                text-align: center;
                color: #5694d7;
                margin-bottom: 30px;
            }

            .form-group {
                margin-bottom: 20px;
            }

            label {
                display: block;
                font-weight: bold;
                margin-bottom: 8px;
                color: #333;
            }

            input, select {
                width: 100%;
                padding: 10px;
                font-size: 14px;
                border: 1px solid #ccc;
                border-radius: 6px;
                box-sizing: border-box;
            }

            button[type="submit"] {
                width: 100%;
                padding: 12px;
                background: #516e8e;
                color: white;
                font-size: 16px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                margin-top: 10px;
                transition: background-color 0.3s;
            }

            button[type="submit"]:hover {
                background: #069ff1;
            }

            .message {
                text-align: center;
                margin-top: 20px;
                font-weight: bold;
            }

            .success {
                color: green;
            }

            .error {
                color: red;
            }

            @media screen and (max-width: 600px) {
                .custom-container {
                    padding: 20px;
                }
            }
            /* Navbar styling */
            .navbar {
                background-color: #516e8e;
            }

            .navbar .nav-link {
                color: white !important;
            }

            .navbar .nav-link:hover,
            .navbar .dropdown-item:hover {
                background-color: #069ff1;
            }

            /* Dropdown menu colors */
            .navbar .dropdown-menu {
                background-color: #516e8e;
            }

            .navbar .dropdown-item {
                color: white !important;
            }


            .navbar-nav {
                overflow: visible !important;
                flex-direction: row;
                flex-wrap: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            .navbar-nav .nav-item {
                flex: 0 0 auto;
            }


            .navbar-collapse {
                overflow: visible !important;
            }

            .dropdown-menu {
                position: absolute;
                z-index: 1050;
            }
        </style>
        <!-- Bootstrap CSS -->
        <link
                href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
                rel="stylesheet"
                integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
                crossorigin="anonymous"
        >
    </head>
    <body>
        <div class="custom-container">
            <nav class="navbar navbar-expand-lg navbar-light ">
                <!-- Toggler button for mobile view -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
                        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Navbar links -->
                <div class="collapse navbar-collapse overflow-x-auto" id="navbarSupportedContent">
                    <ul class="navbar-nav flex-nowrap">
                        <li class="nav-item active">
                            <a class="nav-link" href="/index.html">Home <span class="visually-hidden">(current)</span></a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/html/signup.html">Signup</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/html/signin.html">Login</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/html/memberDetails.html">Profile</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/html/register.html">Register</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/html/list.html">Members</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/html/email.html">Send Notification</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/html/admin.html">Update User Role</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link d-none" href="#" id="refresh-record" onclick="refreshRecord()">Refresh Record</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link d-none" href="#" id="logout-link" onclick="logout()">Logout</a>
                        </li>
                    </ul>
                </div>
            </nav> </br>
            <h4>Update Member Details</h4>
            <form id="memberForm">
                <div class="form-group">
                    <label for="fullName">Full Name:</label>
                    <input type="text" id="fullName" name="fullName">
                </div>
                <div class="form-group">
                    <label for="maritalStatus">Marital Status:</label>
                    <select id="maritalStatus" name="maritalStatus">
                        <option value="">-- Select --</option>
                        <option value="Single">Single</option>
                        <option value="Married">Married</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="email">Email Address:</label>
                    <input type="email" id="email" name="email">
                </div>
                <div class="form-group">
                    <label for="joinDate">Join Date:</label>
                    <input type="date" id="joinDate" name="joinDate">
                </div>
                <div class="form-group">
                    <label for="leaveDate">Leave Date:</label>
                    <input type="date" id="leaveDate" name="leaveDate">
                </div>
                <div class="form-group">
                    <label for="statusChangeDate">Status Change Date:</label>
                    <input type="date" id="statusChangeDate" name="statusChangeDate">
                </div>
                <button type="submit">Update Member</button>
                <div class="message" id="messageBox"></div>
            </form>
            <div id="footer"></div>
        </div>
        <script>
            //Timeout
            let logoutTimer;
            const INACTIVITY_LIMIT = 5 * 60 * 1000; // 5 min

            function resetTimer() {
                clearTimeout(logoutTimer);
                logoutTimer = setTimeout(() => {
                    localStorage.removeItem("user");
                    showErrorModal("You have been logged out due to inactivity.");
                    window.location.href = "/html/signin.html";
                }, INACTIVITY_LIMIT);
            }

            //COMMON
            const user = JSON.parse(localStorage.getItem("user"));
            const member = JSON.parse(localStorage.getItem("member"));

            // Define role-based restrictions
            const restrictedForNone = [
                "/html/register.html", "/html/list.html", "/html/email.html",
                "/html/admin.html", "/html/memberDetails.html", "/html/spouse.html",
                "/html/beneficiary.html", "/html/spouseview.html", "/html/beneficiarylist.html"
            ];
            const restrictedForUser = [
                "/html/register.html", "/html/list.html", "/html/email.html",
                "/html/admin.html", "/html/signup.html", "/html/signin.html"
            ];
            const restrictedForAdmin = [
                "/html/signup.html", "/html/signin.html"
            ];

            const restrictedForSuperAdmin = [
                "/html/signup.html", "/html/signin.html", "/html/memberDetails.html",
                "/html/spouse.html", "/html/beneficiary.html", "/html/spouseview.html", "/html/beneficiarylist.html"
            ];

            // Get role safely
            const role = user?.roles?.[0]?.name?.toUpperCase() || null;

            // Choose restriction list
            function getRestrictedLinks(role) {
                if (role === "SUPER_ADMIN") return restrictedForSuperAdmin;
                if (role === "ADMIN") return restrictedForAdmin;
                if (role === "USER") return restrictedForUser;
                return restrictedForNone;
            }
            const restrictedList = getRestrictedLinks(role);

            // Hide restricted links in the navbar
            const navLinks = document.querySelectorAll(".navbar-nav a");

            navLinks.forEach(link => {
                const href = link.getAttribute("href");
                if (!href) return;

                const path = new URL(href, window.location.origin).pathname;

                if (restrictedList.includes(path)) {
                    const li = link.closest("li.nav-item");
                    if (li) li.style.display = "none";
                    else link.style.display = "none";
                }
            });

            // Show/Hide Logout and Refresh Record links
            const logoutLink = document.getElementById("logout-link");
            const refreshLink = document.getElementById("refresh-record");

            if (logoutLink) {
                logoutLink.classList.toggle("d-none", !(role === "USER" || role === "ADMIN" || role === "SUPER_ADMIN"));
            }

            if (refreshLink) {
                refreshLink.classList.toggle("d-none", (role !== "ADMIN" || role === "SUPER_ADMIN"));
            }
            if (member!==null && member.maritalStatus !== "Married") {
                document.getElementById("spouse-link").style.display = "none";
            }

            function logout() {
                fetch("/api/v1/members/public/logout", {
                    method: "POST",
                    credentials: "include"
                }).then(() => {
                    localStorage.removeItem("user"); // Clear user info from localStorage
                    window.location.href = "/index.html"; // Redirect to home
                }).catch(err => console.error("Logout failed:", err));
            }

            const memberData = localStorage.getItem("editMember");
            let memberId = null;

            function toInputDateFormat(mmddyyyy) {
                if (!mmddyyyy || !mmddyyyy.includes("/")) return "";
                const [mm, dd, yyyy] = mmddyyyy.split("/");
                return `${yyyy}-${mm.padStart(2, "0")}-${dd.padStart(2, "0")}`;
            }

            if (memberData) {
                const member = JSON.parse(memberData);
                memberId = member.memberId;

                document.getElementById("fullName").value = member.fullName || "";
                document.getElementById("maritalStatus").value = member.maritalStatus || "";
                document.getElementById("email").value = member.email || "";

                document.getElementById("joinDate").value = toInputDateFormat(member.joinDate);
                document.getElementById("leaveDate").value = toInputDateFormat(member.leaveDate);
                document.getElementById("statusChangeDate").value = toInputDateFormat(member.statusChangeDate);
            }

            document.getElementById("memberForm").addEventListener("submit", function (e) {
                e.preventDefault();
                const rawJoinDate = document.getElementById("joinDate").value;
                const rawLeaveDate = document.getElementById("leaveDate").value;
                const rawScDate = document.getElementById("statusChangeDate").value;

                const formatDate = (dateStr) => {
                    if (!dateStr) return null;
                    const [year, month, day] = dateStr.split("-");
                    return `${month}/${day}/${year}`;
                };

                const updatedMember = {
                    memberId: memberId,
                    fullName: document.getElementById("fullName").value,
                    maritalStatus: document.getElementById("maritalStatus").value,
                    email: document.getElementById("email").value,
                    joinDate: formatDate(rawJoinDate),
                    leaveDate: formatDate(rawLeaveDate),
                    statusChangeDate: formatDate(rawScDate)
                };

                fetch(`/api/v1/members/admin/update/${memberId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "include",
                    body: JSON.stringify(updatedMember)
                })
                .then(res => {
                    const messageBox = document.getElementById("messageBox");
                    if (res.ok) {
                        window.location.href = "/html/list.html";
                        localStorage.removeItem("editMember");
                    } else {
                        messageBox.textContent = "Update failed. Please try again.";
                        messageBox.className = "message error";
                    }
                    })
                .catch(() => {
                    const messageBox = document.getElementById("messageBox");
                    messageBox.textContent = "Error occurred during update.";
                    messageBox.className = "message error";
                    });
            });
            function refreshRecord(){
                fetch("/api/v1/members/admin/refresh-record", {
                    method: "GET",
                    credentials: "include"
                }).then(() => {
                    window.location.href = "/index.html"; // Redirect to home
                }).catch(err => console.error("Refresh record failed:", err));
            }
            // Inject footer
            fetch("/html/footer.html")
                .then(res => res.text())
                .then(data => document.getElementById("footer").innerHTML = data);
        </script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>

    </body>
</html>
